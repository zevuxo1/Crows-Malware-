// RC4 Encrytion  -MalDev Academy

// This Method Uses the undocumented NTAPI Function for RC4 ecnrption/decryption
// Its Faster and Smaller

#include <Windows.h>
#include <stdio.h>

// SystemFunction032 Takes a USTRING Struct as parameter So we Decalre it
typedef struct {
    DWORD Length;
    DWORD MaximumLength;
    PVOID Buffer;
} USTRING;

// declare the function prototype
typedef NTSTATUS(NTAPI* fnSystemFunction032) (
    struct USTRING* data,
    struct USTRING* key
);

// Actual Function For Decryption/encryption
BOOL Rc4EncryptionSystemFunction(IN PBYTE pRc4Key, IN PBYTE pShellcode, IN DWORD dwRc4KeySize, IN DWORD sShellSize) {
    NTSTATUS STATUS = NULL;


    // Make to USTRING  Varibales
    // One is passed as Key and Other Passed As Payload to encrypt/decrypt
    USTRING key = { .Buffer = pRc4Key, .Length = dwRc4KeySize, .MaximumLength = dwRc4KeySize},
    data = { .Buffer = pShellcode, .Length = sShellSize, .MaximumLength = sShellSize};

    // Load Needed DLL since SystemFunction32 Is Exported From it
    fnSystemFunction032 pSystemFunction32 = (fnSystemFunction032)GetProcAddress(LoadLibraryA("Advapi32"), "SystemFunction032");
    if ((STATUS = pSystemFunction32(&data, &key)) != 0x0) {
        printf("[!] Failed With Code: 0x%0.08", STATUS);
        return FALSE;
    }
    return TRUE;
}

unsigned char code[] = "\x87\x53\x0b\x09"; // Shellcode we want to encrypt/decrypt

unsigned char key[] = {
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F // Key, This Should be changed
};

int main(int argc, char  *argv[])
{
    // if (!Rc4EncryptionSystemFunction(key, code, sizeof(key), sizeof(code))) {
    //    printf("Failed Encrpting");
    //    return 1; 
    // }

    // printf("[*] Encrypted:\n");
    // for (int i = 0; i < sizeof(code); i++) {
    //     printf("\\0x%02x", code[i]);
    // }
    // printf("\n\n");

    if (!Rc4EncryptionSystemFunction(key, code, sizeof(key), sizeof(code))) {
       printf("Failed Encrypting");
       return 1; 
    }

    printf("[*] Decrypted:\n");
    for (int i = 0; i < sizeof(code); i++) {
        printf("\\0x%02x", code[i]);
    }

    return 0;
}

